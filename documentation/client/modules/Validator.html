<!DOCTYPE html>  <html> <head>   <title>Validator.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="Application.html">                 Application.coffee               </a>                                           <a class="source" href="BattleManager.html">                 BattleManager.coffee               </a>                                           <a class="source" href="CanvasAnimations.html">                 CanvasAnimations.coffee               </a>                                           <a class="source" href="CanvasCharacters.html">                 CanvasCharacters.coffee               </a>                                           <a class="source" href="CanvasCharactersExtensions.html">                 CanvasCharactersExtensions.coffee               </a>                                           <a class="source" href="CanvasControls.html">                 CanvasControls.coffee               </a>                                           <a class="source" href="CanvasControlsExtensions.html">                 CanvasControlsExtensions.coffee               </a>                                           <a class="source" href="CanvasLocation.html">                 CanvasLocation.coffee               </a>                                           <a class="source" href="CanvasManager.html">                 CanvasManager.coffee               </a>                                           <a class="source" href="CanvasProjection.html">                 CanvasProjection.coffee               </a>                                           <a class="source" href="CharactersFPPC.html">                 CharactersFPPC.coffee               </a>                                           <a class="source" href="CharactersManager.html">                 CharactersManager.coffee               </a>                                           <a class="source" href="CharactersNPC.html">                 CharactersNPC.coffee               </a>                                           <a class="source" href="CharactersTPPC.html">                 CharactersTPPC.coffee               </a>                                           <a class="source" href="InterfaceHUD.html">                 InterfaceHUD.coffee               </a>                                           <a class="source" href="InterfaceHUDChat.html">                 InterfaceHUDChat.coffee               </a>                                           <a class="source" href="InterfaceHUDDialogs.html">                 InterfaceHUDDialogs.coffee               </a>                                           <a class="source" href="InterfaceManager.html">                 InterfaceManager.coffee               </a>                                           <a class="source" href="InterfacePreparer.html">                 InterfacePreparer.coffee               </a>                                           <a class="source" href="LocationManager.html">                 LocationManager.coffee               </a>                                           <a class="source" href="LocationPathfinder.html">                 LocationPathfinder.coffee               </a>                                           <a class="source" href="Preloader.html">                 Preloader.coffee               </a>                                           <a class="source" href="Socket.html">                 Socket.coffee               </a>                                           <a class="source" href="Utility.html">                 Utility.coffee               </a>                                           <a class="source" href="Validator.html">                 Validator.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               Validator.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h3>———————————————————————————————————————</h3>

<h1>Validator</h1>

<h3>Provides interface to parse forms</h3>

<h3>———————————————————————————————————————</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">String</span><span class="o">::</span><span class="nv">toHMAC = </span><span class="nf">(key) -&gt;</span>
  <span class="k">return</span> <span class="nx">Crypto</span><span class="p">.</span><span class="nx">HMAC</span> <span class="nx">Crypto</span><span class="p">.</span><span class="nx">SHA1</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">key</span>

<span class="nb">String</span><span class="o">::</span><span class="nv">toSHA1 = </span><span class="o">-&gt;</span>
  <span class="k">return</span> <span class="nx">Crypto</span><span class="p">.</span><span class="nx">SHA1</span> <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>———————————————————————————————————————</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">@define</span> <span class="s">&#39;Validator&#39;</span><span class="p">,</span> <span class="nf">(exports) -&gt;</span>
  <span class="p">{</span><span class="nx">ajax</span><span class="p">,</span> <span class="nx">cookie</span><span class="p">,</span> <span class="nx">dom</span><span class="p">}</span> <span class="o">=</span> <span class="nx">atom</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h3>Verifications</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>• Verify if form is filled;</p>

<p><code>form (array)</code>, <code>mistakes (array)</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">verifyFullness = </span><span class="nf">(form, mistakes) -&gt;</span>
    <span class="nx">form</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(field) -&gt;</span>
      <span class="k">if</span> <span class="nx">field</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
        <span class="nx">mistakes</span><span class="p">.</span><span class="nx">push</span>
          <span class="s">&#39;message&#39;</span>  <span class="o">:</span> <span class="s">&#39;Must be filled&#39;</span>
          <span class="s">&#39;selector&#39;</span> <span class="o">:</span>  <span class="nx">field</span><span class="p">.</span><span class="nx">selector</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>• Verify if fields contain valid characters;</p>

<p><code>fields (collection)</code>, <code>mistakes (array)</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">allowed = </span><span class="sr">/[a-zA-Z\d. ]+/g</span>
  <span class="nv">verifyCharacters = </span><span class="nf">(fields..., mistakes) -&gt;</span>
    <span class="nx">fields</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(field) -&gt;</span>
      <span class="k">if</span> <span class="nx">field</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">allowed</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">isnt</span> <span class="mi">0</span>
        <span class="nx">mistakes</span><span class="p">.</span><span class="nx">push</span>
          <span class="s">&#39;message&#39;</span>  <span class="o">:</span> <span class="s">&#39;Invalid characters&#39;</span>
          <span class="s">&#39;selector&#39;</span> <span class="o">:</span>  <span class="nx">field</span><span class="p">.</span><span class="nx">selector</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>• Verify if date is valid;</p>

<p><code>field (object)</code>, <code>mistakes (array)</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">verifyDateFormat = </span><span class="nf">(field, mistakes) -&gt;</span>
    <span class="nv">value = </span><span class="nx">field</span><span class="p">.</span><span class="nx">value</span>

    <span class="k">if</span> <span class="nx">value</span>
      <span class="nv">date = </span><span class="k">new</span> <span class="nb">Date</span> <span class="nx">value</span>

      <span class="nx">date</span><span class="p">.</span><span class="nx">setDate</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>

      <span class="k">if</span> <span class="nx">date</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">is</span> <span class="s">&#39;Invalid Date&#39;</span> <span class="o">or</span> <span class="nx">date</span> <span class="o">&gt;</span> <span class="k">new</span> <span class="nb">Date</span>
        <span class="nx">mistakes</span><span class="p">.</span><span class="nx">push</span>
          <span class="s">&#39;message&#39;</span>  <span class="o">:</span> <span class="s">&#39;Invalid date&#39;</span>
          <span class="s">&#39;selector&#39;</span> <span class="o">:</span> <span class="s">&#39;input#formCalendar&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h3>———————————————————————————————————————</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h3>Work with forms</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>• Divide form to fields;</p>

<p><code>form (dom)</code> —> <code>(array)</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">divide = </span><span class="nf">(form) -&gt;</span>
    <span class="nv">fields = </span><span class="p">[]</span>

    <span class="nx">form</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;input&#39;</span><span class="p">).</span><span class="nx">each</span> <span class="nf">(element, index) -&gt;</span>
      <span class="nx">fields</span><span class="p">.</span><span class="nx">push</span>
        <span class="s">&#39;selector&#39;</span> <span class="o">:</span> <span class="s">&quot;</span><span class="err">#</span><span class="si">#{</span><span class="nx">element</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="s">&#39;value&#39;</span>    <span class="o">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">value</span>

    <span class="k">return</span> <span class="nx">fields</span>

  <span class="nv">notify = </span><span class="nf">(form, mistakes) -&gt;</span>
    <span class="nx">dom</span><span class="p">(</span><span class="s">&#39;.fieldMessage&#39;</span><span class="p">).</span><span class="nx">destroy</span><span class="p">()</span>

    <span class="nx">mistakes</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(mistake) -&gt;</span>
      <span class="nv">messageText = </span><span class="nx">mistake</span><span class="p">.</span><span class="nx">message</span>
      <span class="nv">field       = </span><span class="nx">dom</span> <span class="nx">mistake</span><span class="p">.</span><span class="nx">selector</span>
      <span class="nv">element     = </span><span class="nx">field</span><span class="p">.</span><span class="nx">first</span>

      <span class="nx">field</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&#39;inputInvalid&#39;</span>

      <span class="nv">message = </span><span class="nx">dom</span>
        <span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s">&#39;section&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;fieldMessage&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">css</span><span class="p">(</span>
          <span class="s">&#39;top&#39;</span>  <span class="o">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetTop</span><span class="o">-</span><span class="mf">2.5</span>
          <span class="s">&#39;left&#39;</span> <span class="o">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="o">+</span><span class="nx">element</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="o">+</span><span class="mi">15</span>
        <span class="p">)</span>
        <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">messageText</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">appendTo</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span>

      <span class="nx">field</span><span class="p">.</span><span class="nx">bind</span> <span class="s">&#39;focus&#39;</span><span class="p">,</span> <span class="nv">handler = </span><span class="o">-&gt;</span>
        <span class="nx">field</span><span class="p">.</span><span class="nx">removeClass</span> <span class="s">&#39;inputInvalid&#39;</span>

        <span class="nx">message</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span>

        <span class="nx">field</span><span class="p">.</span><span class="nx">unbind</span> <span class="s">&#39;focus&#39;</span><span class="p">,</span> <span class="nx">handler</span>

  <span class="nv">getRequest = </span><span class="nf">(url, callback) -&gt;</span>
    <span class="nx">ajax</span>
      <span class="s">&#39;method&#39;</span> <span class="o">:</span> <span class="s">&#39;get&#39;</span>
      <span class="s">&#39;cache&#39;</span>  <span class="o">:</span> <span class="s">&#39;false&#39;</span>
      <span class="s">&#39;url&#39;</span>    <span class="o">:</span>  <span class="nx">url</span>

      <span class="nv">onLoad : </span><span class="nx">callback</span>

  <span class="nv">postRequest = </span><span class="nf">(url, callback, data = &#39;&#39;) -&gt;</span>
    <span class="nx">ajax</span>
      <span class="s">&#39;method&#39;</span> <span class="o">:</span> <span class="s">&#39;post&#39;</span>
      <span class="s">&#39;type&#39;</span>   <span class="o">:</span> <span class="s">&#39;plain&#39;</span>
      <span class="s">&#39;cache&#39;</span>  <span class="o">:</span> <span class="s">&#39;false&#39;</span>
      <span class="s">&#39;url&#39;</span>    <span class="o">:</span>  <span class="nx">url</span>
      <span class="s">&#39;data&#39;</span>   <span class="o">:</span>  <span class="nx">data</span>

      <span class="nv">onLoad : </span><span class="nx">callback</span>

  <span class="nv">submit = </span><span class="nf">(form, url, callback) -&gt;</span>
    <span class="nv">data     = </span><span class="nx">divide</span> <span class="nx">form</span>
    <span class="nv">username = </span><span class="nx">data</span><span class="p">.</span><span class="nx">first</span><span class="p">.</span><span class="nx">value</span>

    <span class="nv">digest = </span><span class="nx">data</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">().</span><span class="nx">toHMAC</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span>

    <span class="nx">data</span><span class="p">.</span><span class="nx">push</span> <span class="nx">digest</span>

    <span class="nv">chunk = </span><span class="nx">data</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>

    <span class="nx">ajax</span>
      <span class="s">&#39;method&#39;</span> <span class="o">:</span> <span class="s">&#39;post&#39;</span>
      <span class="s">&#39;type&#39;</span>   <span class="o">:</span> <span class="s">&#39;plain&#39;</span>
      <span class="s">&#39;cache&#39;</span>  <span class="o">:</span> <span class="s">&#39;false&#39;</span>
      <span class="s">&#39;url&#39;</span>    <span class="o">:</span>  <span class="nx">url</span>
      <span class="s">&#39;data&#39;</span>   <span class="o">:</span>  <span class="nx">chunk</span>

      <span class="nv">onLoad : </span><span class="nx">callback</span>

      <span class="nv">onError : </span><span class="nf">(xhr) -&gt;</span>
        <span class="nx">notify</span><span class="p">(</span><span class="nx">form</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h3>POST Requests</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exports.submitLogout = </span><span class="o">-&gt;</span>
    <span class="nx">postRequest</span> <span class="s">&#39;/signout&#39;</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
      <span class="nx">cookie</span><span class="p">.</span><span class="nx">del</span> <span class="s">&#39;id&#39;</span>
      <span class="nx">cookie</span><span class="p">.</span><span class="nx">del</span> <span class="s">&#39;character&#39;</span>

      <span class="nb">window</span><span class="p">.</span><span class="nv">location = </span><span class="s">&#39;/&#39;</span>

  <span class="nv">exports.submitSignin = </span><span class="nf">(form) -&gt;</span>
    <span class="nv">fields   = </span><span class="nx">divide</span> <span class="nx">form</span>
    <span class="nv">mistakes = </span><span class="p">[]</span>

    <span class="nx">verifyFullness</span>   <span class="nx">fields</span><span class="p">,</span>    <span class="nx">mistakes</span>
    <span class="nx">verifyCharacters</span> <span class="nx">fields</span><span class="p">...,</span> <span class="nx">mistakes</span>

    <span class="k">if</span> <span class="nx">mistakes</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">notify</span> <span class="nx">form</span><span class="p">,</span> <span class="nx">mistakes</span>
    <span class="k">else</span>
      <span class="nx">submit</span> <span class="nx">form</span><span class="p">,</span> <span class="s">&#39;/signin/data&#39;</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
        <span class="nx">cookie</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="nx">response</span>

        <span class="nb">window</span><span class="p">.</span><span class="nv">location = </span><span class="s">&#39;/game&#39;</span>

  <span class="nv">exports.submitSignup = </span><span class="nf">(form) -&gt;</span>
    <span class="nv">fields   = </span><span class="nx">divide</span> <span class="nx">form</span>
    <span class="nv">mistakes = </span><span class="p">[]</span>

    <span class="nx">verifyFullness</span>   <span class="nx">fields</span><span class="p">,</span>       <span class="nx">mistakes</span>
    <span class="nx">verifyCharacters</span> <span class="nx">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">2</span><span class="p">]...,</span> <span class="nx">mistakes</span>
    <span class="nx">verifyDateFormat</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">last</span><span class="p">,</span>  <span class="nx">mistakes</span>

    <span class="k">if</span> <span class="nx">mistakes</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">notify</span> <span class="nx">form</span><span class="p">,</span> <span class="nx">mistakes</span>
    <span class="k">else</span>
      <span class="nx">submit</span> <span class="nx">form</span><span class="p">,</span> <span class="s">&#39;/signup/data&#39;</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
        <span class="nx">cookie</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="nx">response</span>

        <span class="nb">window</span><span class="p">.</span><span class="nv">location = </span><span class="s">&#39;/game&#39;</span>

  <span class="nv">exports.submitCharacterCreation = </span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">Application = </span><span class="nx">@require</span> <span class="s">&#39;Application&#39;</span>

    <span class="nv">fields   = </span><span class="nx">divide</span> <span class="nx">form</span>
    <span class="nv">mistakes = </span><span class="p">[]</span>

    <span class="nx">verifyFullness</span>   <span class="nx">fields</span><span class="p">,</span>    <span class="nx">mistakes</span>
    <span class="nx">verifyCharacters</span> <span class="nx">fields</span><span class="p">...,</span> <span class="nx">mistakes</span>

    <span class="k">if</span> <span class="nx">mistakes</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">notify</span> <span class="nx">form</span><span class="p">,</span> <span class="nx">mistakes</span>
    <span class="k">else</span>
      <span class="nx">submit</span> <span class="nx">form</span><span class="p">,</span> <span class="s">&#39;/game/characters/create&#39;</span><span class="p">,</span> <span class="nf">(id) -&gt;</span>
        <span class="nx">Application</span><span class="p">.</span><span class="nx">initiateGame</span> <span class="nx">id</span>

  <span class="nv">exports.submitCharacterSelection = </span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">Application = </span><span class="nx">@require</span> <span class="s">&#39;Application&#39;</span>

    <span class="nv">fields   = </span><span class="nx">divide</span> <span class="nx">form</span>
    <span class="nv">mistakes = </span><span class="p">[]</span>

    <span class="nx">verifyFullness</span>   <span class="nx">fields</span><span class="p">,</span>    <span class="nx">mistakes</span>
    <span class="nx">verifyCharacters</span> <span class="nx">fields</span><span class="p">...,</span> <span class="nx">mistakes</span>

    <span class="k">if</span> <span class="nx">mistakes</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">notify</span> <span class="nx">form</span><span class="p">,</span> <span class="nx">mistakes</span>
    <span class="k">else</span>
      <span class="nx">submit</span> <span class="nx">form</span><span class="p">,</span> <span class="s">&#39;/game/characters/select&#39;</span><span class="p">,</span> <span class="nf">(id) -&gt;</span>
        <span class="nx">Application</span><span class="p">.</span><span class="nx">initiateGame</span> <span class="nx">id</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h3>GET Requests</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exports.requestMyCharacters = </span><span class="nf">(back) -&gt;</span>
    <span class="nx">getRequest</span> <span class="s">&#39;/game/characters/my&#39;</span><span class="p">,</span> <span class="nx">back</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h3>———————————————————————————————————————</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 